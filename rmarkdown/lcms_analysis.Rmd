---
title: "Proteomics grinta!"
author: "Marc A.T. Teunis"
date: "`r Sys.Date()"
output: html_document
---

## Introduction
This workflow is set-up to create a step-by-step workflow in R to pre-preocess and analyze LC/MS data. Severeral packages are being described and explored:

Packages included in this workflow:
`r library(tidyverse, warnings = FALSE, message = FALSE); as_tibble(installed.packages())`

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Packages
To install the necessary packages:
```{r}
## only first time you install Bioconductor packages
# source("http://www.bioconductor.org/biocLite.R")
## source("http://www.bioconductor.org/biocLite.R")
# else
# library("BiocInstaller")
# biocLite("RforProteomics", dependencies = TRUE)
# biocLite("mzR")
# biocLite("msdata")
library("mzR") 
# install.packages("msdata")
# install.packages("readMSdata")
#library("msdata") ## the data package
#library(RforProteomics)
library(tidyverse)
# see: http://mzmatch.sourceforge.net/installation.php
# source("http://bioconductor.org/biocLite.R")
# biocLite(c("xcms", "multtest", "mzR"))

# install.packages(c("rJava", "XML", "snow", "caTools",
#   "bitops", "ptw", "gplots", "tcltk2"))
# source ("http://puma.ibls.gla.ac.uk/mzmatch.R/install_mzmatch.R")
#mzmatch.init()
library(rprojroot)
library(xcms)
#require(mzmatch.R)

```

## Vignettes for "RforProteomics"
see vignette following 
```{r, eval = FALSE}
# list all the vignettes in the RforProteomics package
vignette(package = "RforProteomics")
# Open the vignette called RforProteomics
vignette("RforProteomics", package = "RforProteomics")
# or just
vignette("RforProteomics")
# the vignette for package xcms
browseVignettes(package = "xcms")

```


## To find the R file that contains the code of the Vignette
```{r, eval = FALSE}
rfile <- system.file("doc/RforProteomics.R",
package = "RforProteomics")
rfile
```

## Loading mzXML data from the Grinta! study
```{r define_project_root, include=FALSE}
if(!require("rprojroot")) install.packages("rprojroot", dependencies = TRUE)
root <- rprojroot::find_root_file(criterion = is_rstudio_project)
root
```


## The filepath to the folder containing the *.mzXML files
```{r}

filepath <- paste0(root, "/data-raw/grouped")
# find files from t = x min.

create_xset_from_time <- function(filepath, pattern) {
 
 files_x <- list.files(filepath, full.names = TRUE, 
                       pattern = pattern, 
                       recursive = TRUE)
 xset <- xcmsSet(files = files_x)
 
 return(xset)
}

# test function
test_xset <- create_xset_from_time(filepath = filepath, pattern = "*.mzXML")
test_xset
# file <- dir(system.file(package = "MSnbase", dir = filepath),
#full.names = TRUE, pattern = "*mzXML")
```

```{r}
###################################################
### code chunk number 4: PeakMatching1
###################################################
xset <- group(test_xset)

###################################################
### code chunk number 5: RTCorrection
###################################################
xset2 <- retcor(xset, family = "symmetric", plottype = "mdevden")

###################################################
### code chunk number 6: PeakMatching2
###################################################
xset2 <- group(xset2, bw = 10)


###################################################
### code chunk number 7: PeakFillIn
###################################################
xset3 <- fillPeaks(xset2)
xset3


###################################################
### code chunk number 8: AnalysisVisualize
###################################################
reporttab <- diffreport(xset3, "WT", "KO", "example", 10,
                        metlin = 0.15, h=480, w=640)
reporttab[1:4,]


###################################################
### code chunk number 9: URL1
###################################################
cat("\\url{", as.character(reporttab[1,"metlin"]), "}", sep = "")


###################################################
### code chunk number 10: URL2
###################################################
cat("\\url{", as.character(reporttab[3,"metlin"]), "}", sep = "")


###################################################
### code chunk number 11: PeakSelect
###################################################
gt <- groups(xset3)
colnames(gt)
groupidx1 <- which(gt[,"rtmed"] > 2600 & gt[,"rtmed"] < 2700 & gt[,"npeaks"] == 12)[1]
groupidx2 <- which(gt[,"rtmed"] > 3600 & gt[,"rtmed"] < 3700 & gt[,"npeaks"] == 12)[1]
eiccor <- getEIC(xset3, groupidx = c(groupidx1, groupidx2))
eicraw <- getEIC(xset3, groupidx = c(groupidx1, groupidx2), rt = "raw")


###################################################
### code chunk number 12: EICRaw1
###################################################
plot(eicraw, xset3, groupidx = 1)


###################################################
### code chunk number 13: EICRaw2
###################################################
plot(eicraw, xset3, groupidx = 2)


###################################################
### code chunk number 14: EICCor1
###################################################
plot(eiccor, xset3, groupidx = 1)


###################################################
### code chunk number 15: EICCor2
###################################################
plot(eiccor, xset3, groupidx = 2)


###################################################
### code chunk number 16: warnings
###################################################
cat("These are the warning")
warnings()



```



## 
```{r}
qnt <- readMSData2(files, msLevel = 1, verbose = FALSE, centroided. = TRUE)
plot(qnt[[44]])

plot(qnt)
dev.off()
MAplot(qnt, cex = .8)
```

## Reading files using package "xcms"
```{r}
PeakML.Viewer()
?mzmatch.R	
#browseVignettes(package = "mzmatch.R")

cdffiles <- list.files(filepath, recursive = TRUE, full.names = TRUE)
xset <- xcmsSet(cdffiles)
xset

group_xset <- group(xset)
``` 

# mz_list[[1]]


# headers_list <- lapply(mz_list, header) 
# peaks <- peaks(ms)

headers_list <- lapply(mz_list, header) 


ms <- mz_list[[1]]
ms
runInfo(ms)

peaks <- peaks(mz_list)

# get3Dmap(ms, scans = c(0,10), lowMz = 129, highMz = 302, resMz = 1)
plot(peaks[[1]], xlab = "M/Z", ylab = "Intensity")
plot(peaks[[2]])

hd <- header(ms)
all_hd <- lapply(mz_list, header)

names(hd)

?mzR

head(peaks(ms))

# runInfo(ms)


```

```{r}
mz_plot <- function(ms, scan){

  
  plot(peaks(ms, scan), type = "h", 
     xlab = "M/Z",
     ylab = "Intensity")

  
}

mz_plot(ms, 298)


```

# readMzXmlData
```{r}
library(pacman)
p_load("readMzXmlData")
?`readMzXmlData-package`

spec <- readMzXmlDir(mzXmlDir = filepath)

## plot spectra
plot(spec[[1]]$spectrum$mass, spec[[1]]$spectrum$intensity, type="n")

l <- length(spec)
legendStr <- character(l)

for (i in seq(along=spec)) {
  lines(spec[[i]]$spectrum$mass, spec[[i]]$spectrum$intensity, type="l",
        col=rainbow(l)[i])
  legendStr[i] <- basename(spec[[i]]$metaData$file)
}

## draw legend
legend(x="topright", legend=legendStr, col=rainbow(l), lwd=1)

```


## A heatmap
```{r}
library(MSnbase)
## a set of spectra of interest: MS1 spectra eluted
## between 2 and 13 minutes retention time
ms1 <- which(hd$msLevel == 1)
rtsel <- hd$retentionTime[ms1] / 60 > 2 &
    hd$retentionTime[ms1] / 60 < 13

??MSmap

## the map
<<<<<<< HEAD
M <- MSmap(ms, ms1[rtsel], 200, 800, 0.5, hd)
=======
M <- MSmap(ms, ms1[rtsel], 129, 302, 0.5, hd)
>>>>>>> f3176592a8aa444008f86a42ee9a748bccc5b1af

## 1

plot(M, aspect = 1, allTicks = FALSE)

plot3D(M)

class(M)

## M_df <- as.data.frame(signature(from = M, to =  "data.frame"))

?`plot3D,MSmap-method`

```


```{r}
fileName(mz)
 runInfo(mz_list)
 close(mz)

mzxml <- system.file(paste0("", 
                     package = "msdata")
aa <- openMSfile(mzxml) ## ramp, default backend

## ----get header information-------------------------------------------------------------
runInfo(aa)
instrumentInfo(aa)
header(aa,1)

## ----plotspectrum-----------------------------------------------------------------------
pl <- peaks(aa,10)
peaksCount(aa,10)
head(pl)
plot(pl[,1], pl[,2], type="h", lwd=1)

## ----close the file---------------------------------------------------------------------
close(aa)

## ----openid-----------------------------------------------------------------------------
library(mzR)
library(msdata)

file <- system.file("mzid", "Tandem.mzid.gz", package="msdata")
x <- openIDfile(file)

## ----metadata---------------------------------------------------------------------------
mzidInfo(x)

## ----psms0------------------------------------------------------------------------------
p <- psms(x)
colnames(p)

## ----psms1------------------------------------------------------------------------------
m <- modifications(x)
head(m)

## ----psms2------------------------------------------------------------------------------
scr <- score(x)
colnames(scr)

## ----label=sessioninfo, results='asis', echo=FALSE--------------------------------------
toLatex(sessionInfo())




```





## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
